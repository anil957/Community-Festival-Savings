<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Festival Velam Fund Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üé™ Festival Velam Fund Manager</h1>
                <p class="subtitle">Community Fund & Loan Management System</p>
            </div>
            <div class="user-section">
                <span id="userDisplay">Welcome, <strong>User</strong> | <em id="roleDisplay">Admin</em></span>
                <button id="logoutBtn" class="btn btn-logout">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Summary -->
        <section class="dashboard-summary">
            <h2>üìä Financial Dashboard</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Total Contributions</h3>
                    <p class="metric-value" id="totalContributions">‚Çπ0</p>
                </div>
                <div class="metric-card">
                    <h3>Total Interest Earned</h3>
                    <p class="metric-value" id="totalInterest">‚Çπ0</p>
                </div>
                <div class="metric-card">
                    <h3>Total Loans Given</h3>
                    <p class="metric-value" id="totalLoansGiven">‚Çπ0</p>
                </div>
                <div class="metric-card">
                    <h3>Total Loans Returned</h3>
                    <p class="metric-value" id="totalLoansReturned">‚Çπ0</p>
                </div>
                <div class="metric-card">
                    <h3>Total Expenses</h3>
                    <p class="metric-value" id="totalExpenses">‚Çπ0</p>
                </div>
                <div class="metric-card highlight">
                    <h3>Available Balance</h3>
                    <p class="metric-value" id="availableBalance">‚Çπ0</p>
                </div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-btn active" data-tab="contributions">üí∞ Contributions</button>
            <button class="tab-btn" data-tab="loans">üè¶ Loans (Velam)</button>
            <button class="tab-btn" data-tab="expenses">üêë Expenses</button>
            <button class="tab-btn" data-tab="reports">üìà Reports</button>
        </nav>

        <!-- CONTRIBUTIONS TAB -->
        <section id="contributions-tab" class="tab-content active">
            <div class="section-wrapper">
                <!-- Add Contribution Form -->
                <div class="form-section" id="addContributionSection">
                    <h3>‚ûï Add Monthly Contribution</h3>
                    <form id="contributionForm" class="form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="contDate">Date</label>
                                <input type="date" id="contDate" required>
                            </div>
                            <div class="form-group">
                                <label for="personName">Person Name</label>
                                <input type="text" id="personName" placeholder="Enter person name" required>
                            </div>
                            <div class="form-group">
                                <label for="contributionAmount">Amount (‚Çπ)</label>
                                <input type="number" id="contributionAmount" placeholder="‚Çπ500" min="0" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitContribution">Add Contribution</button>
                    </form>
                </div>

                <!-- Contributions List -->
                <div class="list-section">
                    <h3>üìã Monthly Contributions Log</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Person Name</th>
                                    <th>Amount (‚Çπ)</th>
                                    <th>Month</th>
                                    <th class="admin-col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contributionsList">
                                <tr class="empty-row"><td colspan="5">No contributions yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- LOANS TAB -->
        <section id="loans-tab" class="tab-content">
            <div class="section-wrapper">
                <!-- Add Loan Form -->
                <div class="form-section" id="addLoanSection">
                    <h3>‚ûï Add Loan (Velam)</h3>
                    <form id="loanForm" class="form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="loanDate">Date</label>
                                <input type="date" id="loanDate" required>
                            </div>
                            <div class="form-group">
                                <label for="loanPersonName">Person Name</label>
                                <input type="text" id="loanPersonName" placeholder="Enter person name" required>
                            </div>
                            <div class="form-group">
                                <label for="principalAmount">Principal Amount (‚Çπ)</label>
                                <input type="number" id="principalAmount" placeholder="Loan amount" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="interestAmount">Interest Amount (‚Çπ)</label>
                                <input type="number" id="interestAmount" placeholder="Interest" min="0" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitLoan">Add Loan</button>
                    </form>
                </div>

                <!-- Loans List -->
                <div class="list-section">
                    <h3>üè¶ Active & Returned Loans</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Person Name</th>
                                    <th>Principal (‚Çπ)</th>
                                    <th>Interest (‚Çπ)</th>
                                    <th>Status</th>
                                    <th class="admin-col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loansList">
                                <tr class="empty-row"><td colspan="6">No loans yet</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Top Borrowers Stats -->
                    <div class="stats-box">
                        <h4>Top Borrowers (by frequency)</h4>
                        <ul id="topBorrowersList">
                            <li>No borrowers yet</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- EXPENSES TAB -->
        <section id="expenses-tab" class="tab-content">
            <div class="section-wrapper">
                <!-- Add Expense Form -->
                <div class="form-section" id="addExpenseSection">
                    <h3>‚ûï Add Expense</h3>
                    <form id="expenseForm" class="form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="expenseDate">Date</label>
                                <input type="date" id="expenseDate" required>
                            </div>
                            <div class="form-group">
                                <label for="expenseType">Expense Type</label>
                                <select id="expenseType" required>
                                    <option value="">Select type</option>
                                    <option value="Sheep Purchase">üêë Sheep Purchase</option>
                                    <option value="Miscellaneous">üì¶ Miscellaneous</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="expenseDescription">Description</label>
                                <input type="text" id="expenseDescription" placeholder="e.g., Festival Diwali" required>
                            </div>
                            <div class="form-group">
                                <label for="expenseAmount">Amount (‚Çπ)</label>
                                <input type="number" id="expenseAmount" placeholder="Amount" min="0" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitExpense">Add Expense</button>
                    </form>
                </div>

                <!-- Expenses List -->
                <div class="list-section">
                    <h3>üìù All Expenses</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Amount (‚Çπ)</th>
                                    <th class="admin-col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expensesList">
                                <tr class="empty-row"><td colspan="5">No expenses yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- REPORTS TAB -->
        <section id="reports-tab" class="tab-content">
            <div class="section-wrapper">
                <h3>üìä Monthly Summary Report</h3>
                
                <!-- Chart Container -->
                <div class="chart-container">
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>

                <!-- Monthly Details -->
                <div class="list-section">
                    <h3>Monthly Breakdown</h3>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Contributions (‚Çπ)</th>
                                    <th>Loans Given (‚Çπ)</th>
                                    <th>Loans Returned (‚Çπ)</th>
                                    <th>Interest (‚Çπ)</th>
                                    <th>Expenses (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyReportList">
                                <tr class="empty-row"><td colspan="6">No data available</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>Festival Velam Fund Manager ¬© 2024 | All data stored locally in browser</p>
    </footer>

    <!-- Modal for Editing/Viewing -->
    <div id="editModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3 id="modalTitle">Edit Entry</h3>
            <form id="editForm" class="form">
                <div id="editFormFields"></div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-secondary" id="modalCancelBtn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Initialize app on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded');
            
            // Check authentication
            const userRole = localStorage.getItem('userRole');
            const currentUser = localStorage.getItem('currentUser');

            console.log('User role:', userRole, 'Current user:', currentUser);

            if (!userRole || !currentUser) {
                console.log('No user found, redirecting to login');
                window.location.href = 'index.html';
                return;
            }

            // Display user info
            const userDisplay = document.getElementById('userDisplay');
            const roleDisplay = document.getElementById('roleDisplay');
            
            if (userDisplay) {
                userDisplay.textContent = `Welcome, ${currentUser} | ${userRole === 'ROLE_ADMIN' ? 'Admin' : 'Viewer'}`;
            }
            if (roleDisplay) {
                roleDisplay.textContent = userRole === 'ROLE_ADMIN' ? 'Admin' : 'Viewer';
            }

            // Hide form sections for readonly users
            if (userRole === 'ROLE_READONLY') {
                const addContrib = document.getElementById('addContributionSection');
                const addLoan = document.getElementById('addLoanSection');
                const addExpense = document.getElementById('addExpenseSection');
                
                if (addContrib) addContrib.style.display = 'none';
                if (addLoan) addLoan.style.display = 'none';
                if (addExpense) addExpense.style.display = 'none';
                
                document.querySelectorAll('.admin-col').forEach(el => el.style.display = 'none');
            }

            // Logout handler
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Logout clicked');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                });
            }

            // Initialize FundManager
            console.log('Initializing FundManager');
            setTimeout(() => {
                if (typeof FundManager !== 'undefined') {
                    window.fundManager = new FundManager();
                    window.fundManager.init();
                    console.log('FundManager initialized');
                } else {
                    console.error('FundManager class not found');
                }
            }, 100);
        }, false);
    </script>
</body>
</html>
